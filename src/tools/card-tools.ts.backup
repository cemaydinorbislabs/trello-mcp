import { BaseTool, ToolResult } from './base-tool.js';
import { trelloClient } from '../trello/index.js';

export class GetListCardsTool extends BaseTool {
  readonly name = 'get_list_cards';
  readonly description = 'Belirli bir listedeki kartlarÄ± getir';
  readonly inputSchema = {
    type: 'object',
    properties: {
      listId: {
        type: 'string',
        description: 'Liste ID\'si',
      },
      includeArchived: {
        type: 'boolean',
        description: 'ArÅŸivlenmiÅŸ kartlarÄ± da dahil et (varsayÄ±lan: false)',
        default: false,
      },
      limit: {
        type: 'number',
        description: 'Maksimum kart sayÄ±sÄ± (varsayÄ±lan: 20)',
        default: 20,
      },
    },
    required: ['listId'],
  };

  async execute(args: any): Promise<ToolResult> {
    try {
      this.validateRequired(args, ['listId']);

      const cards = await trelloClient.getListCards(args.listId);
      
      let filteredCards = cards;

      // Filter by archived status
      if (!args.includeArchived) {
        filteredCards = filteredCards.filter(card => !card.closed);
      }

      // Apply limit
      const limit = args.limit || 20;
      const hasMore = filteredCards.length > limit;
      filteredCards = filteredCards.slice(0, limit);

      if (filteredCards.length === 0) {
        return this.success('Bu listede hiÃ§ kart bulunamadÄ±.');
      }

      const lines = [`ğŸ“‹ **Liste KartlarÄ±** (${filteredCards.length} adet${hasMore ? `, ${limit} tanesi gÃ¶steriliyor` : ''})`];
      lines.push('');

      for (let i = 0; i < filteredCards.length; i++) {
        const card = filteredCards[i];
        
        // Kart baÅŸlÄ±ÄŸÄ±
        const cardNumber = i + 1;
        const archivedIcon = card.closed ? 'ğŸ—„ï¸ ' : '';
        lines.push(`${cardNumber}. ${archivedIcon}**${card.name}** (ID: ${card.id})`);
        
        // Temel bilgiler
        if (card.desc && card.desc.trim()) {
          lines.push(`   ğŸ“ ${this.truncateText(card.desc, 80)}`);
        }
        
        if (card.due) {
          const isOverdue = new Date(card.due) < new Date();
          const dueIcon = card.dueComplete ? 'âœ…' : (isOverdue ? 'ğŸ”´' : 'â°');
          lines.push(`   ${dueIcon} Son tarih: ${this.formatDate(card.due)}`);
        }
        
        if (card.labels && card.labels.length > 0) {
          const labelNames = card.labels.map((label: any) => label.name || label.color).join(', ');
          lines.push(`   ğŸ·ï¸ Etiketler: ${labelNames}`);
        }
        
        if (card.members && card.members.length > 0) {
          const memberNames = card.members.map((member: any) => member.fullName || member.username).join(', ');
          lines.push(`   ğŸ‘¥ Ãœyeler: ${memberNames}`);
        }
        
        if (card.badges) {
          if (card.badges.attachments > 0) {
            lines.push(`   ğŸ“ ${card.badges.attachments} ek dosya`);
          }
          if (card.badges.comments > 0) {
            lines.push(`   ğŸ’¬ ${card.badges.comments} yorum`);
          }
          if (card.badges.checkItems > 0) {
            lines.push(`   â˜‘ï¸ ${card.badges.checkItemsChecked}/${card.badges.checkItems} gÃ¶rev tamamlandÄ±`);
          }
        }
        
        lines.push(''); // Kartlar arasÄ± boÅŸluk
      }

      return this.success(lines.join('\n'));

    } catch (error) {
      return this.error(`Kartlar alÄ±nÄ±rken hata oluÅŸtu: ${error instanceof Error ? error.message : 'Bilinmeyen hata'}`);
    }
  }

  /**
   * Power-Up verilerini iÅŸle ve formatla
   */
  private processPowerUpData(card: any, boardCustomFields: any[]): string[] {
    const powerUpData: string[] = [];

    // Custom Fields iÅŸle
    if (card.customFieldItems && card.customFieldItems.length > 0) {
      for (const fieldItem of card.customFieldItems) {
        const fieldDef = boardCustomFields.find(f => f.id === fieldItem.idCustomField);
        if (fieldDef) {
          const value = this.extractCustomFieldValue(fieldItem);
          
          // Story Points iÃ§in Ã¶zel kontrol
          if (this.isStoryPointsField(fieldDef.name)) {
            powerUpData.push(`ğŸ¯ **Story Points:** ${value}`);
          } else if (this.isEpicField(fieldDef.name)) {
            powerUpData.push(`ğŸ“‹ **Epic:** ${value}`);
          } else if (this.isSprintField(fieldDef.name)) {
            powerUpData.push(`ğŸƒ **Sprint:** ${value}`);
          } else {
            powerUpData.push(`â€¢ ${fieldDef.name}: ${value}`);
          }
        }
      }
    }

    // Plugin Data iÅŸle
    if (card.pluginData && card.pluginData.length > 0) {
      for (const plugin of card.pluginData) {
        try {
          const data = JSON.parse(plugin.value);
          
          // Scrum/Agile specific data
          if (data.storyPoints || data.points || data.estimate || data.size) {
            const storyPoints = data.storyPoints || data.points || data.estimate || data.size;
            powerUpData.push(`ğŸ¯ **Story Points:** ${storyPoints}`);
            
            // Remaining hesaplama
            const spent = data.spent || 0;
            const remaining = storyPoints - spent;
            if (remaining >= 0) {
              powerUpData.push(`â³ **Remaining:** ${remaining} (${storyPoints} - ${spent})`);
            }
          }
          
          if (data.spent !== undefined) {
            powerUpData.push(`â±ï¸ **Spent:** ${data.spent}`);
          }
          
          if (data.epic || data.sprint) {
            if (data.epic) powerUpData.push(`ğŸ“‹ **Epic:** ${data.epic}`);
            if (data.sprint) powerUpData.push(`ğŸƒ **Sprint:** ${data.sprint}`);
          }
          
          // Epic ve Sprint iÃ§in daha geniÅŸ arama
          const epicKeys = ['epicName', 'epicId', 'epicTitle'];
          const sprintKeys = ['sprintName', 'sprintId', 'sprintTitle', 'iteration'];
          
          for (const key of epicKeys) {
            if (data[key] && !data.epic) {
              powerUpData.push(`ğŸ“‹ **Epic:** ${data[key]}`);
              break;
            }
          }
          
          for (const key of sprintKeys) {
            if (data[key] && !data.sprint) {
              powerUpData.push(`ğŸƒ **Sprint:** ${data[key]}`);
              break;
            }
          }
          
        } catch (e) {
          // Plugin data parse edilemezse atla
        }
      }
    }

    return powerUpData;
  }

  /**
   * Custom Field deÄŸerini Ã§Ä±kar
   */
  private extractCustomFieldValue(fieldItem: any): string {
    if (!fieldItem.value) return '';
    
    switch (fieldItem.value.type) {
      case 'text':
        return fieldItem.value.text || '';
      case 'number':
        return fieldItem.value.number?.toString() || '';
      case 'checkbox':
        return fieldItem.value.checked ? 'âœ…' : 'âŒ';
      case 'list':
        return fieldItem.value.idValue || '';
      default:
        return JSON.stringify(fieldItem.value);
    }
  }

  /**
   * Story Points field olup olmadÄ±ÄŸÄ±nÄ± kontrol et
   */
  private isStoryPointsField(name: string): boolean {
    if (!name) return false;
    const lowerName = name.toLowerCase();
    return lowerName.includes('story point') || 
           lowerName.includes('size') || 
           lowerName.includes('estimate') ||
           lowerName.includes('points');
  }

  /**
   * Epic field olup olmadÄ±ÄŸÄ±nÄ± kontrol et
   */
  private isEpicField(name: string): boolean {
    if (!name) return false;
    return name.toLowerCase().includes('epic');
  }

  /**
   * Sprint field olup olmadÄ±ÄŸÄ±nÄ± kontrol et
   */
  private isSprintField(name: string): boolean {
    if (!name) return false;
    const lowerName = name.toLowerCase();
    return lowerName.includes('sprint') || lowerName.includes('iteration');
  }
}

// Export all card tools
export const cardTools = [
  new GetListCardsTool(),
  new GetCardTool(),
  new CreateCardTool(),
  new UpdateCardTool(),
  new MoveCardTool(),
  new DeleteCardTool(),
  new ArchiveCardTool(),
  new GetCardWithPowerUpsTool(),
  new GetCardDetailedTool(),
  new GetCardWithScrumDataTool(),
  new GetListCardsWithPowerUpsTool(),
];
      case 'checkbox':
        return fieldItem.value.checked ? 'âœ…' : 'âŒ';
      case 'list':
        return fieldItem.value.idValue || '';
      default:
        return JSON.stringify(fieldItem.value);
    }
  }

  /**
   * Story Points field olup olmadÄ±ÄŸÄ±nÄ± kontrol et
   */
  private isStoryPointsField(name: string): boolean {
    if (!name) return false;
    const lowerName = name.toLowerCase();
    return lowerName.includes('story point') || 
           lowerName.includes('size') || 
           lowerName.includes('estimate') ||
           lowerName.includes('points');
  }

  /**
   * Epic field olup olmadÄ±ÄŸÄ±nÄ± kontrol et
   */
  private isEpicField(name: string): boolean {
    if (!name) return false;
    return name.toLowerCase().includes('epic');
  }

  /**
   * Sprint field olup olmadÄ±ÄŸÄ±nÄ± kontrol et
   */
  private isSprintField(name: string): boolean {
    if (!name) return false;
    const lowerName = name.toLowerCase();
    return lowerName.includes('sprint') || lowerName.includes('iteration');
  }
} from './base-tool.js';
import { trelloClient } from '../trello/client.js';
import { TrelloCard, CreateCardRequest, UpdateCardRequest } from '../trello/types.js';

export class GetListCardsTool extends BaseTool {
  readonly name = 'get_list_cards';
  readonly description = 'Belirli bir listedeki kartlarÄ± getir';
  readonly inputSchema = {
    type: 'object',
    properties: {
      listId: {
        type: 'string',
        description: 'Liste ID\'si',
      },
      includeArchived: {
        type: 'boolean',
        description: 'ArÅŸivlenmiÅŸ kartlarÄ± da dahil et (varsayÄ±lan: false)',
        default: false,
      },
      limit: {
        type: 'number',
        description: 'Maksimum kart sayÄ±sÄ± (varsayÄ±lan: 50)',
        default: 50,
      },
    },
    required: ['listId'],
  };

  async execute(args: any): Promise<ToolResult> {
    try {
      this.validateRequired(args, ['listId']);

      const cards = await trelloClient.getListCards(args.listId);
      
      let filteredCards = cards;

      // Filter by archived status
      if (!args.includeArchived) {
        filteredCards = filteredCards.filter(card => !card.closed);
      }

      // Apply limit
      const limit = args.limit || 50;
      const hasMore = filteredCards.length > limit;
      filteredCards = filteredCards.slice(0, limit);

      if (filteredCards.length === 0) {
        return this.success('Bu listede hiÃ§ kart bulunamadÄ±.');
      }

      const cardList = this.formatList(
        filteredCards,
        (card: TrelloCard) => {
          const lines = [`ğŸ¯ **${card.name}** (ID: ${card.id})`];
          
          if (card.desc && card.desc.trim()) {
            lines.push(`   ğŸ“ ${this.truncateText(card.desc, 80)}`);
          }
          
          if (card.due) {
            const isOverdue = new Date(card.due) < new Date();
            const dueIcon = card.dueComplete ? 'âœ…' : (isOverdue ? 'ğŸ”´' : 'â°');
            lines.push(`   ${dueIcon} Son tarih: ${this.formatDate(card.due)}`);
          }
          
          if (card.labels && card.labels.length > 0) {
            const labelNames = card.labels.map(label => label.name || label.color).join(', ');
            lines.push(`   ğŸ·ï¸ Etiketler: ${labelNames}`);
          }
          
          if (card.members && card.members.length > 0) {
            const memberNames = card.members.map(member => member.fullName || member.username).join(', ');
            lines.push(`   ğŸ‘¥ Ãœyeler: ${memberNames}`);
          }
          
          if (card.badges.attachments > 0) {
            lines.push(`   ğŸ“ ${card.badges.attachments} ek dosya`);
          }
          
          if (card.badges.comments > 0) {
            lines.push(`   ğŸ’¬ ${card.badges.comments} yorum`);
          }
          
          if (card.badges.checkItems > 0) {
            lines.push(`   â˜‘ï¸ ${card.badges.checkItemsChecked}/${card.badges.checkItems} gÃ¶rev tamamlandÄ±`);
          }
          
          if (card.closed) {
            lines.push(`   ğŸ—„ï¸ ArÅŸivlenmiÅŸ`);
          }
          
          return lines.join('\n');
        },
        `ğŸ¯ Kartlar (${filteredCards.length} adet${hasMore ? `, ${limit} tanesi gÃ¶steriliyor` : ''})`
      );

      return this.success(cardList);

    } catch (error) {
      return this.error(`Kartlar alÄ±nÄ±rken hata oluÅŸtu: ${error instanceof Error ? error.message : 'Bilinmeyen hata'}`);
    }
  }

  /**
   * Power-Up verilerini iÅŸle ve formatla
   */
  private processPowerUpData(card: any, boardCustomFields: any[]): string[] {
    const powerUpData: string[] = [];

    // Custom Fields iÅŸle
    if (card.customFieldItems && card.customFieldItems.length > 0) {
      for (const fieldItem of card.customFieldItems) {
        const fieldDef = boardCustomFields.find(f => f.id === fieldItem.idCustomField);
        if (fieldDef) {
          const value = this.extractCustomFieldValue(fieldItem);
          
          // Story Points iÃ§in Ã¶zel kontrol
          if (this.isStoryPointsField(fieldDef.name)) {
            powerUpData.push(`ğŸ¯ **Story Points:** ${value}`);
          } else if (this.isEpicField(fieldDef.name)) {
            powerUpData.push(`ğŸ“‹ **Epic:** ${value}`);
          } else if (this.isSprintField(fieldDef.name)) {
            powerUpData.push(`ğŸƒ **Sprint:** ${value}`);
          } else {
            powerUpData.push(`â€¢ ${fieldDef.name}: ${value}`);
          }
        }
      }
    }

    // Plugin Data iÅŸle
    if (card.pluginData && card.pluginData.length > 0) {
      for (const plugin of card.pluginData) {
        try {
          const data = JSON.parse(plugin.value);
          
          // Scrum/Agile specific data
          if (data.storyPoints || data.points || data.estimate || data.size) {
            const storyPoints = data.storyPoints || data.points || data.estimate || data.size;
            powerUpData.push(`ğŸ¯ **Story Points:** ${storyPoints}`);
            
            // Remaining hesaplama
            const spent = data.spent || 0;
            const remaining = storyPoints - spent;
            if (remaining >= 0) {
              powerUpData.push(`â³ **Remaining:** ${remaining} (${storyPoints} - ${spent})`);
            }
          }
          
          if (data.spent !== undefined) {
            powerUpData.push(`â±ï¸ **Spent:** ${data.spent}`);
          }
          
          if (data.epic || data.sprint) {
            if (data.epic) powerUpData.push(`ğŸ“‹ **Epic:** ${data.epic}`);
            if (data.sprint) powerUpData.push(`ğŸƒ **Sprint:** ${data.sprint}`);
          }
          
          // Epic ve Sprint iÃ§in daha geniÅŸ arama
          const epicKeys = ['epicName', 'epicId', 'epicTitle'];
          const sprintKeys = ['sprintName', 'sprintId', 'sprintTitle', 'iteration'];
          
          for (const key of epicKeys) {
            if (data[key] && !data.epic) {
              powerUpData.push(`ğŸ“‹ **Epic:** ${data[key]}`);
              break;
            }
          }
          
          for (const key of sprintKeys) {
            if (data[key] && !data.sprint) {
              powerUpData.push(`ğŸƒ **Sprint:** ${data[key]}`);
              break;
            }
          }
          
        } catch (e) {
          // Plugin data parse edilemezse atla
        }
      }
    }

    return powerUpData;
  }

  /**
   * Custom Field deÄŸerini Ã§Ä±kar
   */
  private extractCustomFieldValue(fieldItem: any): string {
    if (!fieldItem.value) return '';
    
    switch (fieldItem.value.type) {
      case 'text':
        return fieldItem.value.text || '';
      case 'number':
        return fieldItem.value.number?.toString() || '';
      case 'date':
        return fieldItem.value.date || '';
      case 'checkbox':
        return fieldItem.value.checked ? 'âœ…' : 'âŒ';
      case 'list':
        return fieldItem.value.idValue || '';
      default:
        return JSON.stringify(fieldItem.value);
    }
  }

  /**
   * Story Points field olup olmadÄ±ÄŸÄ±nÄ± kontrol et
   */
  private isStoryPointsField(name: string): boolean {
    if (!name) return false;
    const lowerName = name.toLowerCase();
    return lowerName.includes('story point') || 
           lowerName.includes('size') || 
           lowerName.includes('estimate') ||
           lowerName.includes('points');
  }

  /**
   * Epic field olup olmadÄ±ÄŸÄ±nÄ± kontrol et
   */
  private isEpicField(name: string): boolean {
    if (!name) return false;
    return name.toLowerCase().includes('epic');
  }

  /**
   * Sprint field olup olmadÄ±ÄŸÄ±nÄ± kontrol et
   */
  private isSprintField(name: string): boolean {
    if (!name) return false;
    const lowerName = name.toLowerCase();
    return lowerName.includes('sprint') || lowerName.includes('iteration');
  }
}

export class GetCardTool extends BaseTool {
  readonly name = 'get_card';
  readonly description = 'Belirli bir kartÄ±n detaylÄ± bilgilerini al';
  readonly inputSchema = {
    type: 'object',
    properties: {
      cardId: {
        type: 'string',
        description: 'Kart ID\'si',
      },
    },
    required: ['cardId'],
  };

  async execute(args: any): Promise<ToolResult> {
    try {
      this.validateRequired(args, ['cardId']);

      const card = await trelloClient.getCard(args.cardId);

      const cardInfo = [
        `ğŸ¯ **${card.name}**`,
        `ID: ${card.id}`,
        `URL: ${card.shortUrl}`,
        `Liste ID: ${card.idList}`,
        `Pano ID: ${card.idBoard}`,
        `Pozisyon: ${card.pos}`,
        `Durum: ${card.closed ? 'ğŸ—„ï¸ ArÅŸivlenmiÅŸ' : 'âœ… Aktif'}`,
        `Son aktivite: ${this.formatDate(card.dateLastActivity)}`,
        '',
      ];

      if (card.desc && card.desc.trim()) {
        cardInfo.push('**AÃ§Ä±klama:**', card.desc, '');
      }

      if (card.due) {
        const isOverdue = new Date(card.due) < new Date();
        const dueStatus = card.dueComplete ? 'âœ… TamamlandÄ±' : (isOverdue ? 'ğŸ”´ GecikmiÅŸ' : 'â° Bekliyor');
        cardInfo.push(`**Son Tarih:** ${this.formatDate(card.due)} (${dueStatus})`, '');
      }

      if (card.labels && card.labels.length > 0) {
        cardInfo.push('**Etiketler:**');
        card.labels.forEach(label => {
          cardInfo.push(`â€¢ ${label.name || 'Ä°simsiz'} (${label.color})`);
        });
        cardInfo.push('');
      }

      if (card.members && card.members.length > 0) {
        cardInfo.push('**Ãœyeler:**');
        card.members.forEach(member => {
          cardInfo.push(`â€¢ ${member.fullName} (@${member.username})`);
        });
        cardInfo.push('');
      }

      if (card.badges.attachments > 0 || card.badges.comments > 0 || card.badges.checkItems > 0) {
        cardInfo.push('**Ä°statistikler:**');
        if (card.badges.attachments > 0) {
          cardInfo.push(`ğŸ“ ${card.badges.attachments} ek dosya`);
        }
        if (card.badges.comments > 0) {
          cardInfo.push(`ğŸ’¬ ${card.badges.comments} yorum`);
        }
        if (card.badges.checkItems > 0) {
          cardInfo.push(`â˜‘ï¸ ${card.badges.checkItemsChecked}/${card.badges.checkItems} gÃ¶rev tamamlandÄ±`);
        }
      }

      return this.success(cardInfo.join('\n'));

    } catch (error) {
      return this.error(`Kart bilgileri alÄ±nÄ±rken hata oluÅŸtu: ${error instanceof Error ? error.message : 'Bilinmeyen hata'}`);
    }
  }
}

export class CreateCardTool extends BaseTool {
  readonly name = 'create_card';
  readonly description = 'Yeni bir kart oluÅŸtur';
  readonly inputSchema = {
    type: 'object',
    properties: {
      listId: {
        type: 'string',
        description: 'KartÄ±n ekleneceÄŸi liste ID\'si',
      },
      name: {
        type: 'string',
        description: 'Kart adÄ±',
      },
      description: {
        type: 'string',
        description: 'Kart aÃ§Ä±klamasÄ± (isteÄŸe baÄŸlÄ±)',
      },
      dueDate: {
        type: 'string',
        description: 'Son tarih (ISO 8601 formatÄ±nda, Ã¶rn: 2024-12-31T23:59:59Z)',
      },
      position: {
        type: 'string',
        description: 'Kart pozisyonu ("top", "bottom" veya sayÄ±sal deÄŸer)',
        default: 'bottom',
      },
      memberIds: {
        type: 'array',
        items: { type: 'string' },
        description: 'Karta atanacak Ã¼ye ID\'leri',
      },
      labelIds: {
        type: 'array',
        items: { type: 'string' },
        description: 'Karta eklenecek etiket ID\'leri',
      },
    },
    required: ['listId', 'name'],
  };

  async execute(args: any): Promise<ToolResult> {
    try {
      this.validateRequired(args, ['listId', 'name']);

      const createData: CreateCardRequest = {
        name: args.name.trim(),
        idList: args.listId,
      };

      if (args.description && args.description.trim()) {
        createData.desc = args.description.trim();
      }

      if (args.dueDate) {
        // Validate date format
        const dueDate = new Date(args.dueDate);
        if (isNaN(dueDate.getTime())) {
          return this.error('GeÃ§ersiz tarih formatÄ±. ISO 8601 formatÄ±nda tarih girin (Ã¶rn: 2024-12-31T23:59:59Z)');
        }
        createData.due = args.dueDate;
      }

      if (args.position) {
        createData.pos = args.position;
      }

      if (args.memberIds && args.memberIds.length > 0) {
        createData.idMembers = args.memberIds;
      }

      if (args.labelIds && args.labelIds.length > 0) {
        createData.idLabels = args.labelIds;
      }

      const newCard = await trelloClient.createCard(createData);

      const successMessage = [
        `âœ… Kart baÅŸarÄ±yla oluÅŸturuldu!`,
        ``,
        `ğŸ¯ **${newCard.name}**`,
        `ID: ${newCard.id}`,
        `URL: ${newCard.shortUrl}`,
        `Liste ID: ${newCard.idList}`,
        newCard.desc ? `AÃ§Ä±klama: ${this.truncateText(newCard.desc, 100)}` : '',
        newCard.due ? `Son tarih: ${this.formatDate(newCard.due)}` : '',
        `Pozisyon: ${newCard.pos}`,
      ].filter(line => line !== '').join('\n');

      return this.success(successMessage);

    } catch (error) {
      return this.error(`Kart oluÅŸturulurken hata oluÅŸtu: ${error instanceof Error ? error.message : 'Bilinmeyen hata'}`);
    }
  }
}

export class UpdateCardTool extends BaseTool {
  readonly name = 'update_card';
  readonly description = 'Mevcut bir kartÄ± gÃ¼ncelle';
  readonly inputSchema = {
    type: 'object',
    properties: {
      cardId: {
        type: 'string',
        description: 'GÃ¼ncellenecek kart ID\'si',
      },
      name: {
        type: 'string',
        description: 'Yeni kart adÄ±',
      },
      description: {
        type: 'string',
        description: 'Yeni aÃ§Ä±klama',
      },
      dueDate: {
        type: 'string',
        description: 'Yeni son tarih (ISO 8601 formatÄ±nda)',
      },
      dueComplete: {
        type: 'boolean',
        description: 'Son tarih tamamlanma durumu',
      },
      closed: {
        type: 'boolean',
        description: 'Kart arÅŸivleme durumu',
      },
      position: {
        type: 'string',
        description: 'Yeni pozisyon',
      },
    },
    required: ['cardId'],
  };

  async execute(args: any): Promise<ToolResult> {
    try {
      this.validateRequired(args, ['cardId']);

      const currentCard = await trelloClient.getCard(args.cardId);
      const updateData: UpdateCardRequest = {};
      const changes: string[] = [];

      if (args.name && args.name.trim() !== currentCard.name) {
        updateData.name = args.name.trim();
        changes.push(`Ad: "${currentCard.name}" â†’ "${updateData.name}"`);
      }

      if (args.description !== undefined) {
        const newDesc = args.description.trim();
        if (newDesc !== currentCard.desc) {
          updateData.desc = newDesc;
          changes.push(`AÃ§Ä±klama gÃ¼ncellendi`);
        }
      }

      if (args.dueDate !== undefined) {
        if (args.dueDate === '') {
          updateData.due = null as any;
          changes.push(`Son tarih kaldÄ±rÄ±ldÄ±`);
        } else {
          const dueDate = new Date(args.dueDate);
          if (isNaN(dueDate.getTime())) {
            return this.error('GeÃ§ersiz tarih formatÄ±');
          }
          updateData.due = args.dueDate;
          changes.push(`Son tarih: ${this.formatDate(args.dueDate)}`);
        }
      }

      if (args.dueComplete !== undefined && args.dueComplete !== currentCard.dueComplete) {
        updateData.dueComplete = args.dueComplete;
        changes.push(`Son tarih durumu: ${args.dueComplete ? 'TamamlandÄ±' : 'Bekliyor'}`);
      }

      if (args.closed !== undefined && args.closed !== currentCard.closed) {
        updateData.closed = args.closed;
        changes.push(`Durum: ${args.closed ? 'ArÅŸivlendi' : 'Aktif hale getirildi'}`);
      }

      if (args.position !== undefined) {
        updateData.pos = args.position;
        changes.push(`Pozisyon: ${currentCard.pos} â†’ ${args.position}`);
      }

      if (changes.length === 0) {
        return this.success('HiÃ§ deÄŸiÅŸiklik yapÄ±lmadÄ±.');
      }

      const updatedCard = await trelloClient.updateCard(args.cardId, updateData);

      const successMessage = [
        `âœ… Kart baÅŸarÄ±yla gÃ¼ncellendi!`,
        ``,
        `ğŸ¯ **${updatedCard.name}**`,
        `ID: ${updatedCard.id}`,
        ``,
        `ğŸ”„ DeÄŸiÅŸiklikler:`,
        ...changes.map(change => `â€¢ ${change}`),
      ].join('\n');

      return this.success(successMessage);

    } catch (error) {
      return this.error(`Kart gÃ¼ncellenirken hata oluÅŸtu: ${error instanceof Error ? error.message : 'Bilinmeyen hata'}`);
    }
  }
}

export class MoveCardTool extends BaseTool {
  readonly name = 'move_card';
  readonly description = 'KartÄ± baÅŸka bir listeye taÅŸÄ±';
  readonly inputSchema = {
    type: 'object',
    properties: {
      cardId: {
        type: 'string',
        description: 'TaÅŸÄ±nacak kart ID\'si',
      },
      targetListId: {
        type: 'string',
        description: 'Hedef liste ID\'si',
      },
      position: {
        type: 'string',
        description: 'Hedef pozisyon ("top", "bottom" veya sayÄ±sal deÄŸer)',
        default: 'bottom',
      },
    },
    required: ['cardId', 'targetListId'],
  };

  async execute(args: any): Promise<ToolResult> {
    try {
      this.validateRequired(args, ['cardId', 'targetListId']);

      const currentCard = await trelloClient.getCard(args.cardId);
      const position = args.position || 'bottom';

      const updatedCard = await trelloClient.moveCard(args.cardId, args.targetListId, position);

      const successMessage = [
        `âœ… Kart baÅŸarÄ±yla taÅŸÄ±ndÄ±!`,
        ``,
        `ğŸ¯ **${updatedCard.name}**`,
        `ID: ${updatedCard.id}`,
        ``,
        `ğŸ“‹ Eski liste: ${currentCard.idList}`,
        `ğŸ“‹ Yeni liste: ${updatedCard.idList}`,
        `ğŸ“ Yeni pozisyon: ${updatedCard.pos}`,
      ].join('\n');

      return this.success(successMessage);

    } catch (error) {
      return this.error(`Kart taÅŸÄ±nÄ±rken hata oluÅŸtu: ${error instanceof Error ? error.message : 'Bilinmeyen hata'}`);
    }
  }
}

export class DeleteCardTool extends BaseTool {
  readonly name = 'delete_card';
  readonly description = 'Bir kartÄ± kalÄ±cÄ± olarak sil';
  readonly inputSchema = {
    type: 'object',
    properties: {
      cardId: {
        type: 'string',
        description: 'Silinecek kart ID\'si',
      },
      confirm: {
        type: 'boolean',
        description: 'Silme iÅŸlemini onaylayÄ±n (gÃ¼venlik iÃ§in gerekli)',
        default: false,
      },
    },
    required: ['cardId', 'confirm'],
  };

  async execute(args: any): Promise<ToolResult> {
    try {
      this.validateRequired(args, ['cardId']);

      if (!args.confirm) {
        return this.error('Kart silme iÅŸlemi iÃ§in confirm: true parametresini eklemelisiniz. Bu iÅŸlem geri alÄ±namaz!');
      }

      const card = await trelloClient.getCard(args.cardId);
      
      await trelloClient.deleteCard(args.cardId);

      const successMessage = [
        `ğŸ—‘ï¸ Kart kalÄ±cÄ± olarak silindi!`,
        ``,
        `Silinen kart: **${card.name}**`,
        `ID: ${card.id}`,
        ``,
        `âš ï¸ Bu iÅŸlem geri alÄ±namaz.`,
      ].join('\n');

      return this.success(successMessage);

    } catch (error) {
      return this.error(`Kart silinirken hata oluÅŸtu: ${error instanceof Error ? error.message : 'Bilinmeyen hata'}`);
    }
  }
}

export class ArchiveCardTool extends BaseTool {
  readonly name = 'archive_card';
  readonly description = 'Bir kartÄ± arÅŸivle veya arÅŸivden Ã§Ä±kar';
  readonly inputSchema = {
    type: 'object',
    properties: {
      cardId: {
        type: 'string',
        description: 'Kart ID\'si',
      },
      archive: {
        type: 'boolean',
        description: 'true: arÅŸivle, false: arÅŸivden Ã§Ä±kar (varsayÄ±lan: true)',
        default: true,
      },
    },
    required: ['cardId'],
  };

  async execute(args: any): Promise<ToolResult> {
    try {
      this.validateRequired(args, ['cardId']);

      const { cardId, archive = true } = args;
      
      const updatedCard = await trelloClient.updateCard(cardId, { closed: archive });
      
      const action = archive ? 'arÅŸivlendi' : 'arÅŸivden Ã§Ä±karÄ±ldÄ±';
      return this.success(`Kart "${updatedCard.name}" baÅŸarÄ±yla ${action}.`);
    } catch (error) {
      return this.error(`Kart arÅŸivleme iÅŸlemi baÅŸarÄ±sÄ±z: ${error instanceof Error ? error.message : 'Bilinmeyen hata'}`);
    }
  }
}

export class GetCardWithPowerUpsTool extends BaseTool {
  readonly name = 'get_card_with_powerups';
  readonly description = 'KartÄ±n detaylÄ± bilgilerini Power-Up verileriyle birlikte al';
  readonly inputSchema = {
    type: 'object',
    properties: {
      cardId: {
        type: 'string',
        description: 'Kart ID\'si',
      },
    },
    required: ['cardId'],
  };

  async execute(args: any): Promise<ToolResult> {
    try {
      this.validateRequired(args, ['cardId']);

      const cardData = await trelloClient.getCardWithAllData(args.cardId);
      
      const lines = [`ğŸ¯ **${cardData.name}** (ID: ${cardData.id})`];
      
      if (cardData.desc && cardData.desc.trim()) {
        lines.push(`   ğŸ“ ${this.truncateText(cardData.desc, 80)}`);
      }
      
      if (cardData.due) {
        const isOverdue = new Date(cardData.due) < new Date();
        const dueIcon = cardData.dueComplete ? 'âœ…' : (isOverdue ? 'ğŸ”´' : 'â°');
        lines.push(`   ${dueIcon} Son tarih: ${this.formatDate(cardData.due)}`);
      }
      
      if (cardData.labels && cardData.labels.length > 0) {
        const labelNames = cardData.labels.map(label => label.name || label.color).join(', ');
        lines.push(`   ğŸ·ï¸ Etiketler: ${labelNames}`);
      }
      
      if (cardData.members && cardData.members.length > 0) {
        const memberNames = cardData.members.map(member => member.fullName || member.username).join(', ');
        lines.push(`   ğŸ‘¥ Ãœyeler: ${memberNames}`);
      }
      
      if (cardData.badges.attachments > 0) {
        lines.push(`   ğŸ“ ${cardData.badges.attachments} ek dosya`);
      }
      
      if (cardData.badges.comments > 0) {
        lines.push(`   ğŸ’¬ ${cardData.badges.comments} yorum`);
      }
      
      if (cardData.badges.checkItems > 0) {
        lines.push(`   â˜‘ï¸ ${cardData.badges.checkItemsChecked}/${cardData.badges.checkItems} gÃ¶rev tamamlandÄ±`);
      }
      
      if (cardData.closed) {
        lines.push(`   ğŸ—„ï¸ ArÅŸivlenmiÅŸ`);
      }

      // Power-Up verilerini ekle
      lines.push(`\nğŸ”Œ **Power-Up Verileri:**`);
      
      // Custom Fields
      if (cardData.customFields && cardData.customFields.length > 0) {
        lines.push(`   ğŸ“Š **Custom Fields:** ${cardData.customFields.length} adet`);
        
        if (cardData.customFieldItems && cardData.customFieldItems.length > 0) {
          for (const field of cardData.customFields) {
            const fieldItem = cardData.customFieldItems.find((item: any) => item.idCustomField === field.id);
            if (fieldItem) {
              let value = '';
              if (fieldItem.value) {
                switch (fieldItem.value.type) {
                  case 'text':
                    value = fieldItem.value.text || '';
                    break;
                  case 'number':
                    value = fieldItem.value.number?.toString() || '';
                    break;
                  case 'date':
                    value = fieldItem.value.date || '';
                    break;
                  case 'checkbox':
                    value = fieldItem.value.checked ? 'âœ…' : 'âŒ';
                    break;
                  case 'list':
                    value = fieldItem.value.idValue || '';
                    break;
                  default:
                    value = JSON.stringify(fieldItem.value);
                }
              }
              
              // Story Points iÃ§in Ã¶zel kontrol
              if (field.name && field.name.toLowerCase().includes('story point') || 
                  field.name && field.name.toLowerCase().includes('size') ||
                  field.name && field.name.toLowerCase().includes('estimate')) {
                lines.push(`     ğŸ¯ **Story Points:** ${value}`);
              } else if (field.name && field.name.toLowerCase().includes('epic')) {
                lines.push(`     ğŸ“‹ **Epic:** ${value}`);
              } else if (field.name && field.name.toLowerCase().includes('sprint')) {
                lines.push(`     ğŸƒ **Sprint:** ${value}`);
              } else {
                lines.push(`     â€¢ ${field.name}: ${value}`);
              }
            }
          }
        } else {
          lines.push(`   ğŸ“‹ **Custom Field Items:** DeÄŸer yok`);
        }
      } else {
        lines.push(`   ğŸ“Š **Custom Fields:** Mevcut deÄŸil`);
      }

      // Plugin Data (Story Points vb.)
      if (cardData.pluginData && cardData.pluginData.length > 0) {
        lines.push(`   ğŸ¯ **Plugin Data:** ${cardData.pluginData.length} adet`);
        
        for (const plugin of cardData.pluginData) {
          try {
            const data = JSON.parse(plugin.value);
            
            // Scrum/Agile specific data
            if (data.storyPoints || data.points || data.estimate || data.size) {
              const storyPoints = data.storyPoints || data.points || data.estimate || data.size;
              lines.push(`     ğŸ¯ **Story Points:** ${storyPoints}`);
              
              // Remaining hesaplama
              const spent = data.spent || 0;
              const remaining = storyPoints - spent;
              if (remaining >= 0) {
                lines.push(`     â³ **Remaining:** ${remaining} (${storyPoints} - ${spent})`);
              }
            }
            
            if (data.spent || data.remaining) {
              lines.push(`     â±ï¸ **Spent:** ${data.spent || 0}`);
            }
            
            if (data.epic || data.sprint) {
              lines.push(`     ğŸ“‹ **Epic:** ${data.epic || 'N/A'}`);
              lines.push(`     ğŸƒ **Sprint:** ${data.sprint || 'N/A'}`);
            }
            
            // Epic ve Sprint iÃ§in daha geniÅŸ arama
            const epicKeys = ['epic', 'epicName', 'epicId', 'epicTitle'];
            const sprintKeys = ['sprint', 'sprintName', 'sprintId', 'sprintTitle', 'iteration'];
            
            for (const key of epicKeys) {
              if (data[key] && !data.epic) {
                lines.push(`     ğŸ“‹ **Epic:** ${data[key]}`);
                break;
              }
            }
            
            for (const key of sprintKeys) {
              if (data[key] && !data.sprint) {
                lines.push(`     ğŸƒ **Sprint:** ${data[key]}`);
                break;
              }
            }
            
            // DiÄŸer plugin verileri
            if (Object.keys(data).length > 0) {
              for (const [key, value] of Object.entries(data)) {
                if (!['storyPoints', 'points', 'estimate', 'size', 'spent', 'remaining', 'epic', 'sprint', 'epicName', 'epicId', 'epicTitle', 'sprintName', 'sprintId', 'sprintTitle', 'iteration'].includes(key)) {
                  lines.push(`     â€¢ ${key}: ${value}`);
                }
              }
            }
          } catch (e) {
            // Plugin data parse edilemezse raw data'yÄ± gÃ¶ster
            lines.push(`     â€¢ ${plugin.idPlugin}: ${plugin.value.substring(0, 100)}...`);
          }
        }
      } else {
        lines.push(`   ğŸ¯ **Plugin Data:** Mevcut deÄŸil`);
      }
      
      return this.success(lines.join('\n'));

    } catch (error) {
      // Daha detaylÄ± hata mesajÄ± oluÅŸtur
      let errorMessage = 'Bilinmeyen hata';
      
      if (error instanceof Error) {
        errorMessage = error.message;
        
        // EÄŸer detaylÄ± hata bilgisi varsa ekle
        if ((error as any).endpoint) {
          errorMessage += ` (Endpoint: ${(error as any).endpoint})`;
        }
        if ((error as any).method) {
          errorMessage += ` (Method: ${(error as any).method})`;
        }
        if ((error as any).originalError) {
          const originalError = (error as any).originalError;
          if (originalError instanceof Error) {
            errorMessage += ` (Original: ${originalError.message})`;
          }
        }
      } else if (typeof error === 'string') {
        errorMessage = error;
      } else if (error && typeof error === 'object') {
        errorMessage = JSON.stringify(error);
      }
      
      return this.error(`Kart bilgileri alÄ±nÄ±rken hata oluÅŸtu: ${errorMessage}`);
    }
  }
}

export class GetCardDetailedTool extends BaseTool {
  readonly name = 'get_card_detailed';
  readonly description = 'KartÄ±n detaylÄ± bilgilerini al (Power-Up desteÄŸi ile)';
  readonly inputSchema = {
    type: 'object',
    properties: {
      cardId: {
        type: 'string',
        description: 'Kart ID\'si',
      },
    },
    required: ['cardId'],
  };

  async execute(args: any): Promise<ToolResult> {
    try {
      this.validateRequired(args, ['cardId']);

      // Ã–nce normal kart bilgilerini al
      const card = await trelloClient.getCard(args.cardId);
      
      const lines = [`ğŸ¯ **${card.name}** (ID: ${card.id})`];
      
      if (card.desc && card.desc.trim()) {
        lines.push(`   ğŸ“ ${this.truncateText(card.desc, 80)}`);
      }
      
      if (card.due) {
        const isOverdue = new Date(card.due) < new Date();
        const dueIcon = card.dueComplete ? 'âœ…' : (isOverdue ? 'ğŸ”´' : 'â°');
        lines.push(`   ${dueIcon} Son tarih: ${this.formatDate(card.due)}`);
      }
      
      if (card.labels && card.labels.length > 0) {
        const labelNames = card.labels.map(label => label.name || label.color).join(', ');
        lines.push(`   ğŸ·ï¸ Etiketler: ${labelNames}`);
      }
      
      if (card.members && card.members.length > 0) {
        const memberNames = card.members.map(member => member.fullName || member.username).join(', ');
        lines.push(`   ğŸ‘¥ Ãœyeler: ${memberNames}`);
      }
      
      if (card.badges.attachments > 0) {
        lines.push(`   ğŸ“ ${card.badges.attachments} ek dosya`);
      }
      
      if (card.badges.comments > 0) {
        lines.push(`   ğŸ’¬ ${card.badges.comments} yorum`);
      }
      
      if (card.badges.checkItems > 0) {
        lines.push(`   â˜‘ï¸ ${card.badges.checkItemsChecked}/${card.badges.checkItems} gÃ¶rev tamamlandÄ±`);
      }
      
      if (card.closed) {
        lines.push(`   ğŸ—„ï¸ ArÅŸivlenmiÅŸ`);
      }

      // Power-Up verilerini ayrÄ± ayrÄ± kontrol et
      lines.push(`\nğŸ”Œ **Power-Up KontrolÃ¼:**`);
      
      try {
        const customFields = await trelloClient.getBoardCustomFields(card.idBoard);
        if (customFields && customFields.length > 0) {
          lines.push(`   ğŸ“Š **Custom Fields:** ${customFields.length} adet mevcut`);
          
          // Custom field items'larÄ± kontrol et
          try {
            const customFieldItems = await trelloClient.getCardCustomFields(args.cardId);
            if (customFieldItems && customFieldItems.length > 0) {
              lines.push(`   ğŸ“‹ **Custom Field Items:** ${customFieldItems.length} adet deÄŸer`);
              
              // Her custom field iÃ§in deÄŸer gÃ¶ster
              for (const field of customFields) {
                const fieldItem = customFieldItems.find((item: any) => item.idCustomField === field.id);
                if (fieldItem) {
                  let value = '';
                  if (fieldItem.value) {
                    switch (fieldItem.value.type) {
                      case 'text':
                        value = fieldItem.value.text || '';
                        break;
                      case 'number':
                        value = fieldItem.value.number?.toString() || '';
                        break;
                      case 'date':
                        value = fieldItem.value.date || '';
                        break;
                      case 'checkbox':
                        value = fieldItem.value.checked ? 'âœ…' : 'âŒ';
                        break;
                      case 'list':
                        value = fieldItem.value.idValue || '';
                        break;
                      default:
                        value = JSON.stringify(fieldItem.value);
                    }
                  }
                  
                  // Story Points iÃ§in Ã¶zel kontrol
                  if (field.name && field.name.toLowerCase().includes('story point') || 
                      field.name && field.name.toLowerCase().includes('size') ||
                      field.name && field.name.toLowerCase().includes('estimate')) {
                    lines.push(`     ğŸ¯ **Story Points:** ${value}`);
                  } else if (field.name && field.name.toLowerCase().includes('epic')) {
                    lines.push(`     ğŸ“‹ **Epic:** ${value}`);
                  } else if (field.name && field.name.toLowerCase().includes('sprint')) {
                    lines.push(`     ğŸƒ **Sprint:** ${value}`);
                  } else {
                    lines.push(`     â€¢ ${field.name}: ${value}`);
                  }
                }
              }
            } else {
              lines.push(`   ğŸ“‹ **Custom Field Items:** DeÄŸer yok`);
            }
          } catch (error) {
            lines.push(`   ğŸ“‹ **Custom Field Items:** EriÅŸim hatasÄ±`);
          }
        } else {
          lines.push(`   ğŸ“Š **Custom Fields:** Mevcut deÄŸil`);
        }
      } catch (error) {
        lines.push(`   ğŸ“Š **Custom Fields:** EriÅŸim hatasÄ±`);
      }

      // Plugin Data kontrolÃ¼ ekle
      try {
        const pluginData = await trelloClient.getCardPluginData(args.cardId);
        if (pluginData && pluginData.length > 0) {
          lines.push(`   ğŸ”Œ **Plugin Data:** ${pluginData.length} adet mevcut`);
          
          for (const plugin of pluginData) {
            try {
              const data = JSON.parse(plugin.value);
              
              // Scrum/Agile specific data
              if (data.storyPoints || data.points || data.estimate || data.size) {
                const storyPoints = data.storyPoints || data.points || data.estimate || data.size;
                lines.push(`     ğŸ¯ **Story Points:** ${storyPoints}`);
                
                // Remaining hesaplama
                const spent = data.spent || 0;
                const remaining = storyPoints - spent;
                if (remaining >= 0) {
                  lines.push(`     â³ **Remaining:** ${remaining} (${storyPoints} - ${spent})`);
                }
              }
              
              if (data.spent || data.remaining) {
                lines.push(`     â±ï¸ **Spent:** ${data.spent || 0}`);
              }
              
              if (data.epic || data.sprint) {
                lines.push(`     ğŸ“‹ **Epic:** ${data.epic || 'N/A'}`);
                lines.push(`     ğŸƒ **Sprint:** ${data.sprint || 'N/A'}`);
              }
              
              // Epic ve Sprint iÃ§in daha geniÅŸ arama
              const epicKeys = ['epic', 'epicName', 'epicId', 'epicTitle'];
              const sprintKeys = ['sprint', 'sprintName', 'sprintId', 'sprintTitle', 'iteration'];
              
              for (const key of epicKeys) {
                if (data[key] && !data.epic) {
                  lines.push(`     ğŸ“‹ **Epic:** ${data[key]}`);
                  break;
                }
              }
              
              for (const key of sprintKeys) {
                if (data[key] && !data.sprint) {
                  lines.push(`     ğŸƒ **Sprint:** ${data[key]}`);
                  break;
                }
              }
              
              // DiÄŸer plugin verileri
              if (Object.keys(data).length > 0) {
                for (const [key, value] of Object.entries(data)) {
                  if (!['storyPoints', 'points', 'estimate', 'size', 'spent', 'remaining', 'epic', 'sprint', 'epicName', 'epicId', 'epicTitle', 'sprintName', 'sprintId', 'sprintTitle', 'iteration'].includes(key)) {
                    lines.push(`     â€¢ ${key}: ${value}`);
                  }
                }
              }
            } catch (e) {
              // Plugin data parse edilemezse raw data'yÄ± gÃ¶ster
              lines.push(`     â€¢ ${plugin.idPlugin}: ${plugin.value.substring(0, 100)}...`);
            }
          }
        } else {
          lines.push(`   ğŸ”Œ **Plugin Data:** Mevcut deÄŸil`);
        }
      } catch (error) {
        lines.push(`   ğŸ”Œ **Plugin Data:** EriÅŸim hatasÄ±`);
      }
      
      return this.success(lines.join('\n'));

    } catch (error) {
      let errorMessage = 'Bilinmeyen hata';
      
      if (error instanceof Error) {
        errorMessage = error.message;
      } else if (typeof error === 'string') {
        errorMessage = error;
      } else if (error && typeof error === 'object') {
        errorMessage = JSON.stringify(error);
      }
      
      return this.error(`Kart bilgileri alÄ±nÄ±rken hata oluÅŸtu: ${errorMessage}`);
    }
  }
}

export class GetCardWithScrumDataTool extends BaseTool {
  readonly name = 'get_card_with_scrum_data';
  readonly description = 'KartÄ±n Scrum/Agile Power-Up verilerini dahil detaylÄ± bilgilerini al';
  readonly inputSchema = {
    type: 'object',
    properties: {
      cardId: {
        type: 'string',
        description: 'Kart ID\'si',
      },
    },
    required: ['cardId'],
  };

  async execute(args: any): Promise<ToolResult> {
    try {
      this.validateRequired(args, ['cardId']);

      // TÃ¼m verileri al
      const cardData = await trelloClient.getCardWithAllData(args.cardId);
      
      const lines = [`ğŸ¯ **${cardData.name}** (ID: ${cardData.id})`];
      
      if (cardData.desc && cardData.desc.trim()) {
        lines.push(`   ğŸ“ ${this.truncateText(cardData.desc, 80)}`);
      }
      
      if (cardData.due) {
        const isOverdue = new Date(cardData.due) < new Date();
        const dueIcon = cardData.dueComplete ? 'âœ…' : (isOverdue ? 'ğŸ”´' : 'â°');
        lines.push(`   ${dueIcon} Son tarih: ${this.formatDate(cardData.due)}`);
      }
      
      if (cardData.labels && cardData.labels.length > 0) {
        const labelNames = cardData.labels.map(label => label.name || label.color).join(', ');
        lines.push(`   ğŸ·ï¸ Etiketler: ${labelNames}`);
      }
      
      if (cardData.members && cardData.members.length > 0) {
        const memberNames = cardData.members.map(member => member.fullName || member.username).join(', ');
        lines.push(`   ğŸ‘¥ Ãœyeler: ${memberNames}`);
      }
      
      if (cardData.badges.attachments > 0) {
        lines.push(`   ğŸ“ ${cardData.badges.attachments} ek dosya`);
      }
      
      if (cardData.badges.comments > 0) {
        lines.push(`   ğŸ’¬ ${cardData.badges.comments} yorum`);
      }
      
      if (cardData.badges.checkItems > 0) {
        lines.push(`   â˜‘ï¸ ${cardData.badges.checkItemsChecked}/${cardData.badges.checkItems} gÃ¶rev tamamlandÄ±`);
      }
      
      if (cardData.closed) {
        lines.push(`   ğŸ—„ï¸ ArÅŸivlenmiÅŸ`);
      }

      // Debug bilgisi - tÃ¼m verileri gÃ¶ster
      lines.push(`\nğŸ” **DEBUG - TÃ¼m Veriler:**`);
      lines.push(`   ğŸ“Š **Custom Fields:** ${cardData.customFields?.length || 0} adet`);
      lines.push(`   ğŸ“‹ **Custom Field Items:** ${cardData.customFieldItems?.length || 0} adet`);
      lines.push(`   ğŸ”Œ **Plugin Data:** ${cardData.pluginData?.length || 0} adet`);
      lines.push(`   ğŸ“ **Attachments:** ${cardData.attachments?.length || 0} adet`);
      lines.push(`   ğŸ“ **Actions:** ${cardData.actions?.length || 0} adet`);
      lines.push(`   ğŸ·ï¸ **Stickers:** ${cardData.stickers?.length || 0} adet`);
      lines.push(`   â˜‘ï¸ **Checklists:** ${cardData.checklists?.length || 0} adet`);
      lines.push(`   ğŸ”Œ **Board Plugins:** ${cardData.boardPlugins?.length || 0} adet`);

      // Custom Fields detaylarÄ±
      if (cardData.customFields && cardData.customFields.length > 0) {
        lines.push(`\nğŸ“Š **Custom Fields DetaylarÄ±:**`);
        for (const field of cardData.customFields) {
          lines.push(`   â€¢ ${field.name} (${field.type}) - ID: ${field.id}`);
        }
      }

      // Custom Field Items detaylarÄ±
      if (cardData.customFieldItems && cardData.customFieldItems.length > 0) {
        lines.push(`\nğŸ“‹ **Custom Field Items DetaylarÄ±:**`);
        for (const item of cardData.customFieldItems) {
          lines.push(`   â€¢ Field ID: ${item.idCustomField}`);
          lines.push(`     Value: ${JSON.stringify(item.value)}`);
        }
      }

      // Plugin Data detaylarÄ±
      if (cardData.pluginData && cardData.pluginData.length > 0) {
        lines.push(`\nğŸ”Œ **Plugin Data DetaylarÄ±:**`);
        for (const plugin of cardData.pluginData) {
          lines.push(`   â€¢ Plugin ID: ${plugin.idPlugin}`);
          lines.push(`     Value: ${plugin.value.substring(0, 200)}...`);
        }
      }

      // Board Plugins detaylarÄ±
      if (cardData.boardPlugins && cardData.boardPlugins.length > 0) {
        lines.push(`\nğŸ”Œ **Board Plugins DetaylarÄ±:**`);
        for (const plugin of cardData.boardPlugins) {
          lines.push(`   â€¢ Plugin: ${plugin.name || plugin.id} - ${plugin.description || 'No description'}`);
        }
      }

      // Stickers detaylarÄ±
      if (cardData.stickers && cardData.stickers.length > 0) {
        lines.push(`\nğŸ·ï¸ **Stickers DetaylarÄ±:**`);
        for (const sticker of cardData.stickers) {
          lines.push(`   â€¢ ${sticker.name || sticker.id} - ${sticker.imageUrl || 'No image'}`);
        }
      }

      // Checklists detaylarÄ±
      if (cardData.checklists && cardData.checklists.length > 0) {
        lines.push(`\nâ˜‘ï¸ **Checklists DetaylarÄ±:**`);
        for (const checklist of cardData.checklists) {
          lines.push(`   â€¢ ${checklist.name} - ${checklist.checkItems?.length || 0} items`);
          if (checklist.checkItems && checklist.checkItems.length > 0) {
            for (const item of checklist.checkItems.slice(0, 3)) {
              lines.push(`     - ${item.name} (${item.state})`);
            }
            if (checklist.checkItems.length > 3) {
              lines.push(`     ... ve ${checklist.checkItems.length - 3} tane daha`);
            }
          }
        }
      }

      // Actions detaylarÄ±
      if (cardData.actions && cardData.actions.length > 0) {
        lines.push(`\nğŸ“ **Actions DetaylarÄ± (Son 5):**`);
        for (const action of cardData.actions.slice(0, 5)) {
          lines.push(`   â€¢ Type: ${action.type}`);
          if (action.data) {
            lines.push(`     Data: ${JSON.stringify(action.data).substring(0, 100)}...`);
          }
        }
      }

      // Scrum/Agile Power-Up verilerini parse et
      lines.push(`\nğŸ¯ **Scrum/Agile Power-Up Verileri:**`);
      
      // Custom Fields'dan Story Points ara
      if (cardData.customFields && cardData.customFields.length > 0) {
        lines.push(`   ğŸ“Š **Custom Fields:** ${cardData.customFields.length} adet`);
        
        if (cardData.customFieldItems && cardData.customFieldItems.length > 0) {
          lines.push(`   ğŸ“‹ **Custom Field Items:** ${cardData.customFieldItems.length} adet`);
          
          for (const field of cardData.customFields) {
            const fieldItem = cardData.customFieldItems.find((item: any) => item.idCustomField === field.id);
            if (fieldItem) {
              let value = '';
              if (fieldItem.value) {
                switch (fieldItem.value.type) {
                  case 'text':
                    value = fieldItem.value.text || '';
                    break;
                  case 'number':
                    value = fieldItem.value.number?.toString() || '';
                    break;
                  case 'date':
                    value = fieldItem.value.date || '';
                    break;
                  case 'checkbox':
                    value = fieldItem.value.checked ? 'âœ…' : 'âŒ';
                    break;
                  case 'list':
                    value = fieldItem.value.idValue || '';
                    break;
                  default:
                    value = JSON.stringify(fieldItem.value);
                }
              }
              
              // Story Points iÃ§in Ã¶zel kontrol
              if (field.name && field.name.toLowerCase().includes('story point') || 
                  field.name && field.name.toLowerCase().includes('size') ||
                  field.name && field.name.toLowerCase().includes('estimate')) {
                lines.push(`     ğŸ¯ **Story Points:** ${value}`);
              } else if (field.name && field.name.toLowerCase().includes('epic')) {
                lines.push(`     ğŸ“‹ **Epic:** ${value}`);
              } else if (field.name && field.name.toLowerCase().includes('sprint')) {
                lines.push(`     ğŸƒ **Sprint:** ${value}`);
              } else {
                lines.push(`     â€¢ ${field.name}: ${value}`);
              }
            }
          }
        }
      } else {
        lines.push(`   ğŸ“Š **Custom Fields:** Mevcut deÄŸil`);
      }

      // Plugin Data'dan Scrum verilerini ara
      if (cardData.pluginData && cardData.pluginData.length > 0) {
        lines.push(`   ğŸ”Œ **Plugin Data:** ${cardData.pluginData.length} adet`);
        
        for (const plugin of cardData.pluginData) {
          try {
            const data = JSON.parse(plugin.value);
            
            // Scrum/Agile specific data
            if (data.storyPoints || data.points || data.estimate || data.size) {
              const storyPoints = data.storyPoints || data.points || data.estimate || data.size;
              lines.push(`     ğŸ¯ **Story Points:** ${storyPoints}`);
              
              // Remaining hesaplama
              const spent = data.spent || 0;
              const remaining = storyPoints - spent;
              if (remaining >= 0) {
                lines.push(`     â³ **Remaining:** ${remaining} (${storyPoints} - ${spent})`);
              }
            }
            
            if (data.spent || data.remaining) {
              lines.push(`     â±ï¸ **Spent:** ${data.spent || 0}`);
            }
            
            if (data.epic || data.sprint) {
              lines.push(`     ğŸ“‹ **Epic:** ${data.epic || 'N/A'}`);
              lines.push(`     ğŸƒ **Sprint:** ${data.sprint || 'N/A'}`);
            }
            
            // Epic ve Sprint iÃ§in daha geniÅŸ arama
            const epicKeys = ['epic', 'epicName', 'epicId', 'epicTitle'];
            const sprintKeys = ['sprint', 'sprintName', 'sprintId', 'sprintTitle', 'iteration'];
            
            for (const key of epicKeys) {
              if (data[key] && !data.epic) {
                lines.push(`     ğŸ“‹ **Epic:** ${data[key]}`);
                break;
              }
            }
            
            for (const key of sprintKeys) {
              if (data[key] && !data.sprint) {
                lines.push(`     ğŸƒ **Sprint:** ${data[key]}`);
                break;
              }
            }
            
            // DiÄŸer plugin verileri
            if (Object.keys(data).length > 0) {
              for (const [key, value] of Object.entries(data)) {
                if (!['storyPoints', 'points', 'estimate', 'size', 'spent', 'remaining', 'epic', 'sprint', 'epicName', 'epicId', 'epicTitle', 'sprintName', 'sprintId', 'sprintTitle', 'iteration'].includes(key)) {
                  lines.push(`     â€¢ ${key}: ${value}`);
                }
              }
            }
          } catch (e) {
            // Plugin data parse edilemezse raw data'yÄ± gÃ¶ster
            lines.push(`     â€¢ ${plugin.idPlugin}: ${plugin.value.substring(0, 100)}...`);
          }
        }
      } else {
        lines.push(`   ğŸ”Œ **Plugin Data:** Mevcut deÄŸil`);
      }

      // Actions'dan Power-Up verilerini ara
      if (cardData.actions && cardData.actions.length > 0) {
        lines.push(`   ğŸ“ **Actions:** ${cardData.actions.length} adet`);
        
        // Son Power-Up action'larÄ±nÄ± bul
        const powerUpActions = cardData.actions.filter((action: any) => 
          action.type === 'updateCard' && 
          action.data && 
          (action.data.old || action.data.card)
        );
        
        if (powerUpActions.length > 0) {
          lines.push(`   ğŸ”„ **Power-Up Actions:** ${powerUpActions.length} adet`);
          
          for (const action of powerUpActions.slice(0, 5)) { // Son 5 action
            if (action.data && action.data.old) {
              lines.push(`     â€¢ ${action.type}: ${JSON.stringify(action.data.old).substring(0, 50)}...`);
            }
          }
        }
      } else {
        lines.push(`   ğŸ“ **Actions:** Mevcut deÄŸil`);
      }
      
      return this.success(lines.join('\n'));

    } catch (error) {
      let errorMessage = 'Bilinmeyen hata';
      
      if (error instanceof Error) {
        errorMessage = error.message;
      } else if (typeof error === 'string') {
        errorMessage = error;
      } else if (error && typeof error === 'object') {
        errorMessage = JSON.stringify(error);
      }
      
      return this.error(`Kart bilgileri alÄ±nÄ±rken hata oluÅŸtu: ${errorMessage}`);
    }
  }
}

export class GetListCardsWithPowerUpsTool extends BaseTool {
  readonly name = 'get_list_cards_with_powerups';
  readonly description = 'Listedeki tÃ¼m kartlarÄ± Power-Up verileriyle birlikte getir (optimize edilmiÅŸ)';
  readonly inputSchema = {
    type: 'object',
    properties: {
      listId: {
        type: 'string',
        description: 'Liste ID\'si',
      },
      includeArchived: {
        type: 'boolean',
        description: 'ArÅŸivlenmiÅŸ kartlarÄ± da dahil et (varsayÄ±lan: false)',
        default: false,
      },
      includePowerUps: {
        type: 'boolean',
        description: 'Power-Up verilerini dahil et (varsayÄ±lan: true)',
        default: true,
      },
      limit: {
        type: 'number',
        description: 'Maksimum kart sayÄ±sÄ± (varsayÄ±lan: 20)',
        default: 20,
      },
      fields: {
        type: 'string',
        description: 'Hangi kart field\'larÄ±nÄ± getireceÄŸi (all, name,desc,due,labels vb.)',
        default: 'all',
      },
    },
    required: ['listId'],
  };

  async execute(args: any): Promise<ToolResult> {
    try {
      this.validateRequired(args, ['listId']);

      // 1. Optimize edilmiÅŸ ÅŸekilde kartlarÄ± getir
      const cards = await trelloClient.getListCardsOptimized(args.listId, {
        fields: args.fields || 'all',
        includeCustomFields: args.includePowerUps,
        includePluginData: args.includePowerUps,
        includeMembers: true,
        includeLabels: true,
      });
      
      let filteredCards = cards;

      // Filter by archived status
      if (!args.includeArchived) {
        filteredCards = filteredCards.filter(card => !card.closed);
      }

      // Apply limit
      const limit = args.limit || 20;
      const hasMore = filteredCards.length > limit;
      filteredCards = filteredCards.slice(0, limit);

      if (filteredCards.length === 0) {
        return this.success('Bu listede hiÃ§ kart bulunamadÄ±.');
      }

      // 2. Board'daki custom field tanÄ±mlarÄ±nÄ± bir kez getir
      let boardCustomFields: any[] = [];
      if (args.includePowerUps && filteredCards.length > 0) {
        try {
          const boardId = filteredCards[0].idBoard;
          boardCustomFields = await trelloClient.getBoardCustomFields(boardId);
        } catch (error) {
          // Hata varsa devam et, sadece custom field tanÄ±mlarÄ± olmayacak
        }
      }

      const lines = [`ğŸ“‹ **Liste KartlarÄ±** (${filteredCards.length} adet${hasMore ? `, ${limit} tanesi gÃ¶steriliyor` : ''})`];
      lines.push('');

      // 3. KartlarÄ± formatla
      for (let i = 0; i < filteredCards.length; i++) {
        const card = filteredCards[i];
        
        lines.push(`**${i + 1}. ğŸ¯ ${card.name}** (ID: ${card.id})`);
        
        // Temel kart bilgileri
        if (card.desc && card.desc.trim()) {
          lines.push(`   ğŸ“ ${this.truncateText(card.desc, 80)}`);
        }
        
        if (card.due) {
          const isOverdue = new Date(card.due) < new Date();
          const dueIcon = card.dueComplete ? 'âœ…' : (isOverdue ? 'ğŸ”´' : 'â°');
          lines.push(`   ${dueIcon} Son tarih: ${this.formatDate(card.due)}`);
        }
        
        if (card.labels && card.labels.length > 0) {
          const labelNames = card.labels.map(label => label.name || label.color).join(', ');
          lines.push(`   ğŸ·ï¸ Etiketler: ${labelNames}`);
        }
        
        if (card.members && card.members.length > 0) {
          const memberNames = card.members.map(member => member.fullName || member.username).join(', ');
          lines.push(`   ğŸ‘¥ Ãœyeler: ${memberNames}`);
        }
        
        if (card.badges?.attachments > 0) {
          lines.push(`   ğŸ“ ${card.badges.attachments} ek dosya`);
        }
        
        if (card.badges?.comments > 0) {
          lines.push(`   ğŸ’¬ ${card.badges.comments} yorum`);
        }
        
        if (card.badges?.checkItems > 0) {
          lines.push(`   â˜‘ï¸ ${card.badges.checkItemsChecked}/${card.badges.checkItems} gÃ¶rev tamamlandÄ±`);
        }
        
        if (card.closed) {
          lines.push(`   ğŸ—„ï¸ ArÅŸivlenmiÅŸ`);
        }

        // Power-Up verilerini iÅŸle
        if (args.includePowerUps) {
          const powerUpData = this.processPowerUpData(card, boardCustomFields);
          if (powerUpData.length > 0) {
            lines.push(`   ğŸ”Œ **Power-Up Verileri:**`);
            lines.push(...powerUpData.map(data => `     ${data}`));
          } else {
            lines.push(`   ğŸ”Œ **Power-Up Verileri:** Mevcut deÄŸil`);
          }
        }
        
        lines.push(''); // Kartlar arasÄ± boÅŸluk
      }

      return this.success(lines.join('\n'));

    } catch (error) {
      return this.error(`Kartlar alÄ±nÄ±rken hata oluÅŸtu: ${error instanceof Error ? error.message : 'Bilinmeyen hata'}`);
    }
  }
}

// Export all card tools
export const cardTools = [
  new GetListCardsTool(),
  new GetCardTool(),
  new CreateCardTool(),
  new UpdateCardTool(),
  new MoveCardTool(),
  new DeleteCardTool(),
  new ArchiveCardTool(),
  new GetCardWithPowerUpsTool(),
  new GetCardDetailedTool(),
  new GetCardWithScrumDataTool(),
  new GetListCardsWithPowerUpsTool(),
];
